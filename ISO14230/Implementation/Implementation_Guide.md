# ğŸ› ï¸ ISO 14230 (KWP2000) åè®®å®ç°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°
æœ¬æ–‡æ¡£æä¾›ISO 14230 Keyword Protocol 2000 (KWP2000) åè®®çš„è¯¦ç»†å®ç°æŒ‡å—ï¼ŒåŸºäºSSF 14230ç‘å…¸å®æ–½æ ‡å‡†å’ŒISO 14230å›½é™…æ ‡å‡†ï¼ŒåŒ…å«ä»£ç ç¤ºä¾‹ã€æœ€ä½³å®è·µå’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚

## ğŸ—ï¸ å®ç°æ¶æ„

### è½¯ä»¶æ¶æ„ (åŸºäºOSIæ¨¡å‹)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åº”ç”¨å±‚ (Application)    â”‚ â† è¯Šæ–­æœåŠ¡å’ŒåŠŸèƒ½å•å…ƒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         KWP2000åè®®æ ˆ           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        åº”ç”¨å±‚ (AL)          â”‚ â”‚ â† ISO 14230-3
â”‚  â”‚    - è¯Šæ–­ç®¡ç†åŠŸèƒ½å•å…ƒ       â”‚ â”‚
â”‚  â”‚    - æ•°æ®ä¼ è¾“åŠŸèƒ½å•å…ƒ       â”‚ â”‚
â”‚  â”‚    - å­˜å‚¨æ•°æ®ä¼ è¾“åŠŸèƒ½å•å…ƒ   â”‚ â”‚
â”‚  â”‚    - è¾“å…¥è¾“å‡ºæ§åˆ¶åŠŸèƒ½å•å…ƒ   â”‚ â”‚
â”‚  â”‚    - è¿œç¨‹æ¿€æ´»ä¾‹ç¨‹åŠŸèƒ½å•å…ƒ   â”‚ â”‚
â”‚  â”‚    - ä¸Šä¼ ä¸‹è½½åŠŸèƒ½å•å…ƒ       â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚      æ•°æ®é“¾è·¯å±‚ (DLL)       â”‚ â”‚ â† ISO 14230-2
â”‚  â”‚    - æ¶ˆæ¯æ ¼å¼å’Œä¼ è¾“æ§åˆ¶     â”‚ â”‚
â”‚  â”‚    - é€šä¿¡æœåŠ¡               â”‚ â”‚
â”‚  â”‚    - é”™è¯¯å¤„ç†               â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚        ç‰©ç†å±‚ (PL)          â”‚ â”‚ â† ISO 14230-1
â”‚  â”‚    - ç”µæ°”ç‰¹æ€§å’Œæ¥å£         â”‚ â”‚
â”‚  â”‚    - æ—¶åºæ§åˆ¶               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ç¡¬ä»¶æŠ½è±¡å±‚ (HAL)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ç¡¬ä»¶æ¥å£ (UART)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—
1. **åè®®æ ˆç®¡ç†å™¨**: åè°ƒå„å±‚å·¥ä½œï¼Œç®¡ç†çŠ¶æ€è½¬æ¢
2. **æ¶ˆæ¯å¤„ç†å™¨**: å¤„ç†å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼Œå®ç°æ¶ˆæ¯æ ¼å¼è½¬æ¢
3. **çŠ¶æ€æœº**: ç®¡ç†é€šä¿¡çŠ¶æ€å’Œä¼šè¯çŠ¶æ€
4. **å®šæ—¶å™¨**: å¤„ç†ä¸¥æ ¼çš„æ—¶åºè¦æ±‚
5. **é”™è¯¯å¤„ç†å™¨**: é”™è¯¯æ£€æµ‹ã€æ¢å¤å’Œè¯Šæ–­
6. **å®‰å…¨è®¿é—®ç®¡ç†å™¨**: å®ç°ç§å­-å¯†é’¥æœºåˆ¶

## ğŸ’» ä»£ç ç¤ºä¾‹

### Cè¯­è¨€å®ç°æ¡†æ¶

#### 1. æ•°æ®ç»“æ„å®šä¹‰
```c
// KWP2000æ¶ˆæ¯ç»“æ„ (åŸºäºISO 14230-2)
typedef struct {
    uint8_t format;      // æ¶ˆæ¯æ ¼å¼ (Format byte)
    uint8_t target;      // ç›®æ ‡åœ°å€ (Target address)
    uint8_t source;      // æºåœ°å€ (Source address)
    uint8_t length;      // æ•°æ®é•¿åº¦ (Length byte)
    uint8_t data[255];   // æ•°æ®å†…å®¹ (Data bytes)
    uint8_t checksum;    // æ ¡éªŒå’Œ (Checksum byte)
} kwp2000_message_t;

// åè®®çŠ¶æ€æšä¸¾ (åŸºäºISO 14230-2)
typedef enum {
    KWP_IDLE,           // ç©ºé—²çŠ¶æ€
    KWP_INIT,           // åˆå§‹åŒ–çŠ¶æ€
    KWP_COMMUNICATING,  // é€šä¿¡çŠ¶æ€
    KWP_ERROR           // é”™è¯¯çŠ¶æ€
} kwp2000_state_t;

// ä¼šè¯çŠ¶æ€æšä¸¾ (åŸºäºISO 14230-3)
typedef enum {
    SESSION_DEFAULT,    // é»˜è®¤ä¼šè¯
    SESSION_PROGRAMMING,// ç¼–ç¨‹ä¼šè¯
    SESSION_EXTENDED    // æ‰©å±•ä¼šè¯
} diagnostic_session_t;

// åè®®é…ç½®ç»“æ„
typedef struct {
    uint32_t baudrate;  // æ³¢ç‰¹ç‡ (10400, 9600, 4800)
    uint8_t timeout;    // è¶…æ—¶æ—¶é—´ (ms)
    uint8_t retries;    // é‡è¯•æ¬¡æ•°
    uint8_t target_addr;// ç›®æ ‡åœ°å€
    uint8_t source_addr;// æºåœ°å€
} kwp2000_config_t;

// å®‰å…¨è®¿é—®çŠ¶æ€
typedef struct {
    uint8_t level;      // å®‰å…¨è®¿é—®çº§åˆ«
    uint8_t seed[4];    // ç§å­æ•°æ®
    uint8_t key[4];     // å¯†é’¥æ•°æ®
    bool unlocked;      // è§£é”çŠ¶æ€
} security_access_t;
```

#### 2. åˆå§‹åŒ–å‡½æ•°
```c
/**
 * åˆå§‹åŒ–KWP2000åè®®æ ˆ
 * @param config åè®®é…ç½®å‚æ•°
 * @return 0:æˆåŠŸ, -1:å¤±è´¥
 */
int kwp2000_init(kwp2000_config_t *config) {
    // éªŒè¯é…ç½®å‚æ•°
    if (config->baudrate != 10400 && 
        config->baudrate != 9600 && 
        config->baudrate != 4800) {
        return -1;
    }
    
    // åˆå§‹åŒ–ç¡¬ä»¶æ¥å£ (åŸºäºISO 14230-1)
    if (uart_init(config->baudrate) != 0) {
        return -1;
    }
    
    // åˆå§‹åŒ–åè®®çŠ¶æ€
    kwp_state = KWP_IDLE;
    kwp_config = *config;
    current_session = SESSION_DEFAULT;
    
    // åˆå§‹åŒ–å®‰å…¨è®¿é—®
    memset(&security, 0, sizeof(security_access_t));
    
    // åˆå§‹åŒ–å®šæ—¶å™¨
    timer_init();
    
    return 0;
}
```

#### 3. æ¶ˆæ¯å‘é€å‡½æ•° (åŸºäºISO 14230-2)
```c
/**
 * å‘é€KWP2000æ¶ˆæ¯
 * @param msg æ¶ˆæ¯ç»“æ„æŒ‡é’ˆ
 * @return 0:æˆåŠŸ, -1:å¤±è´¥
 */
int kwp2000_send_message(kwp2000_message_t *msg) {
    uint8_t buffer[260];
    int i, len = 0;
    
    // éªŒè¯æ¶ˆæ¯æ ¼å¼
    if (msg->length > 255) {
        return -1;
    }
    
    // æ„å»ºæ¶ˆæ¯å¸§ (åŸºäºISO 14230-2æ¶ˆæ¯ç»“æ„)
    buffer[len++] = msg->format;
    buffer[len++] = msg->target;
    buffer[len++] = msg->source;
    buffer[len++] = msg->length;
    
    // æ·»åŠ æ•°æ®
    for (i = 0; i < msg->length; i++) {
        buffer[len++] = msg->data[i];
    }
    
    // è®¡ç®—æ ¡éªŒå’Œ (åŸºäºISO 14230-2)
    msg->checksum = calculate_checksum(buffer, len);
    buffer[len++] = msg->checksum;
    
    // å‘é€æ¶ˆæ¯
    return uart_send(buffer, len);
}

/**
 * è®¡ç®—æ ¡éªŒå’Œ (åŸºäºISO 14230-2)
 */
uint8_t calculate_checksum(uint8_t *data, int length) {
    uint8_t checksum = 0;
    for (int i = 0; i < length; i++) {
        checksum += data[i];
    }
    return checksum;
}
```

#### 4. æ¶ˆæ¯æ¥æ”¶å‡½æ•°
```c
/**
 * æ¥æ”¶KWP2000æ¶ˆæ¯
 * @param msg æ¶ˆæ¯ç»“æ„æŒ‡é’ˆ
 * @return 0:æˆåŠŸ, -1:å¤±è´¥
 */
int kwp2000_receive_message(kwp2000_message_t *msg) {
    uint8_t buffer[260];
    int len, i;
    
    // æ¥æ”¶æ¶ˆæ¯å¸§
    len = uart_receive(buffer, sizeof(buffer));
    if (len < 5) {  // æœ€å°æ¶ˆæ¯é•¿åº¦ (Format+Target+Source+Length+Checksum)
        return -1;
    }
    
    // è§£ææ¶ˆæ¯å¤´ (åŸºäºISO 14230-2)
    msg->format = buffer[0];
    msg->target = buffer[1];
    msg->source = buffer[2];
    msg->length = buffer[3];
    
    // éªŒè¯é•¿åº¦
    if (len != (5 + msg->length)) {
        return -1;
    }
    
    // å¤åˆ¶æ•°æ®
    for (i = 0; i < msg->length; i++) {
        msg->data[i] = buffer[4 + i];
    }
    
    // éªŒè¯æ ¡éªŒå’Œ
    msg->checksum = buffer[len - 1];
    if (msg->checksum != calculate_checksum(buffer, len - 1)) {
        return -1;
    }
    
    return 0;
}
```

#### 5. å¿«é€Ÿåˆå§‹åŒ–å®ç° (åŸºäºISO 14230-2)
```c
/**
 * å¿«é€Ÿåˆå§‹åŒ–åºåˆ—
 * @return 0:æˆåŠŸ, -1:å¤±è´¥
 */
int kwp2000_fast_init(void) {
    uint8_t key_bytes[2];
    kwp2000_message_t msg;
    
    // å‘é€å¿«é€Ÿåˆå§‹åŒ–å…³é”®è¯ (åŸºäºISO 14230-2)
    key_bytes[0] = 0x81;  // å¿«é€Ÿåˆå§‹åŒ–å…³é”®è¯
    key_bytes[1] = 0x11;  // æ—¶åºå‚æ•°
    
    // æ„å»ºåˆå§‹åŒ–æ¶ˆæ¯
    msg.format = 0x81;
    msg.target = 0x33;    // åŠŸèƒ½åœ°å€
    msg.source = kwp_config.source_addr;
    msg.length = 2;
    msg.data[0] = key_bytes[0];
    msg.data[1] = key_bytes[1];
    
    // å‘é€åˆå§‹åŒ–æ¶ˆæ¯
    if (kwp2000_send_message(&msg) != 0) {
        return -1;
    }
    
    // ç­‰å¾…ECUå“åº”
    if (wait_for_response(50) != 0) {  // 50msè¶…æ—¶
        return -1;
    }
    
    // æ¥æ”¶ECUå“åº”
    if (kwp2000_receive_message(&msg) != 0) {
        return -1;
    }
    
    // éªŒè¯å“åº”
    if (msg.format != 0xC1 || msg.length != 2) {
        return -1;
    }
    
    // æ›´æ–°æ—¶åºå‚æ•°
    update_timing_parameters(msg.data[0], msg.data[1]);
    
    kwp_state = KWP_COMMUNICATING;
    return 0;
}
```

#### 6. è¯Šæ–­æœåŠ¡å®ç° (åŸºäºISO 14230-3)

##### 6.1 å¯åŠ¨è¯Šæ–­ä¼šè¯
```c
/**
 * å¯åŠ¨è¯Šæ–­ä¼šè¯ (åŸºäºISO 14230-3)
 * @param session_type ä¼šè¯ç±»å‹
 * @return 0:æˆåŠŸ, -1:å¤±è´¥
 */
int kwp2000_start_diagnostic_session(diagnostic_session_t session_type) {
    kwp2000_message_t msg;
    
    // æ„å»ºå¯åŠ¨è¯Šæ–­ä¼šè¯è¯·æ±‚
    msg.format = 0x81;
    msg.target = kwp_config.target_addr;
    msg.source = kwp_config.source_addr;
    msg.length = 2;
    msg.data[0] = 0x10;  // StartDiagnosticSession SID
    msg.data[1] = session_type;  // ä¼šè¯ç±»å‹
    
    // å‘é€è¯·æ±‚
    if (kwp2000_send_message(&msg) != 0) {
        return -1;
    }
    
    // æ¥æ”¶å“åº”
    if (kwp2000_receive_message(&msg) != 0) {
        return -1;
    }
    
    // éªŒè¯å“åº”
    if (msg.format != 0xC1 || msg.data[0] != 0x50) {
        return -1;
    }
    
    current_session = session_type;
    return 0;
}
```

##### 6.2 å®‰å…¨è®¿é—®å®ç°
```c
/**
 * å®‰å…¨è®¿é—® (åŸºäºISO 14230-3)
 * @param level å®‰å…¨è®¿é—®çº§åˆ«
 * @return 0:æˆåŠŸ, -1:å¤±è´¥
 */
int kwp2000_security_access(uint8_t level) {
    kwp2000_message_t msg;
    uint8_t seed[4], key[4];
    
    // æ­¥éª¤1: è¯·æ±‚ç§å­
    msg.format = 0x81;
    msg.target = kwp_config.target_addr;
    msg.source = kwp_config.source_addr;
    msg.length = 2;
    msg.data[0] = 0x27;  // SecurityAccess SID
    msg.data[1] = level; // å®‰å…¨è®¿é—®çº§åˆ«
    
    if (kwp2000_send_message(&msg) != 0) {
        return -1;
    }
    
    if (kwp2000_receive_message(&msg) != 0) {
        return -1;
    }
    
    // éªŒè¯ç§å­å“åº”
    if (msg.format != 0xC1 || msg.data[0] != 0x67) {
        return -1;
    }
    
    // æå–ç§å­
    int seed_length = msg.length - 1;
    memcpy(seed, &msg.data[1], seed_length);
    
    // æ­¥éª¤2: è®¡ç®—å¯†é’¥
    calculate_security_key(seed, seed_length, key, level);
    
    // æ­¥éª¤3: å‘é€å¯†é’¥
    msg.format = 0x81;
    msg.target = kwp_config.target_addr;
    msg.source = kwp_config.source_addr;
    msg.length = 2 + seed_length;
    msg.data[0] = 0x27;  // SecurityAccess SID
    msg.data[1] = level + 1; // å¯†é’¥è¯·æ±‚çº§åˆ«
    memcpy(&msg.data[2], key, seed_length);
    
    if (kwp2000_send_message(&msg) != 0) {
        return -1;
    }
    
    if (kwp2000_receive_message(&msg) != 0) {
        return -1;
    }
    
    // éªŒè¯å¯†é’¥å“åº”
    if (msg.format != 0xC1 || msg.data[0] != 0x67) {
        return -1;
    }
    
    security.unlocked = true;
    security.level = level;
    return 0;
}

/**
 * è®¡ç®—å®‰å…¨å¯†é’¥ (ç¤ºä¾‹ç®—æ³•)
 */
void calculate_security_key(uint8_t *seed, int seed_length, uint8_t *key, uint8_t level) {
    // è¿™é‡Œå®ç°å…·ä½“çš„å¯†é’¥è®¡ç®—ç®—æ³•
    // å®é™…ç®—æ³•ç”±è½¦è¾†åˆ¶é€ å•†å®šä¹‰
    for (int i = 0; i < seed_length; i++) {
        key[i] = seed[i] ^ 0x55;  // ç®€å•ç¤ºä¾‹ç®—æ³•
    }
}
```

##### 6.3 è¯»å–æ•°æ®æœåŠ¡
```c
/**
 * æŒ‰æœ¬åœ°æ ‡è¯†ç¬¦è¯»å–æ•°æ® (åŸºäºISO 14230-3)
 * @param identifier æœ¬åœ°æ ‡è¯†ç¬¦
 * @param data æ•°æ®ç¼“å†²åŒº
 * @param max_length æœ€å¤§é•¿åº¦
 * @return å®é™…è¯»å–é•¿åº¦, -1:å¤±è´¥
 */
int kwp2000_read_data_by_local_identifier(uint8_t identifier, uint8_t *data, int max_length) {
    kwp2000_message_t msg;
    
    // æ„å»ºè¯»å–æ•°æ®è¯·æ±‚
    msg.format = 0x81;
    msg.target = kwp_config.target_addr;
    msg.source = kwp_config.source_addr;
    msg.length = 2;
    msg.data[0] = 0x21;  // ReadDataByLocalIdentifier SID
    msg.data[1] = identifier;
    
    if (kwp2000_send_message(&msg) != 0) {
        return -1;
    }
    
    if (kwp2000_receive_message(&msg) != 0) {
        return -1;
    }
    
    // éªŒè¯å“åº”
    if (msg.format != 0xC1 || msg.data[0] != 0x61) {
        return -1;
    }
    
    // æå–æ•°æ®
    int data_length = msg.length - 1;
    if (data_length > max_length) {
        return -1;
    }
    
    memcpy(data, &msg.data[1], data_length);
    return data_length;
}
```

#### 7. çŠ¶æ€æœºå®ç°
```c
/**
 * KWP2000çŠ¶æ€æœºå¤„ç† (åŸºäºISO 14230-2)
 */
void kwp2000_state_machine(void) {
    static uint32_t last_activity = 0;
    uint32_t current_time = get_system_time();
    
    switch (kwp_state) {
        case KWP_IDLE:
            // ç­‰å¾…åˆå§‹åŒ–å‘½ä»¤
            if (check_init_request()) {
                kwp_state = KWP_INIT;
                start_init_sequence();
            }
            break;
            
        case KWP_INIT:
            // å¤„ç†åˆå§‹åŒ–åºåˆ—
            if (process_init_sequence()) {
                kwp_state = KWP_COMMUNICATING;
                last_activity = current_time;
            } else if (current_time - last_activity > INIT_TIMEOUT) {
                kwp_state = KWP_ERROR;
            }
            break;
            
        case KWP_COMMUNICATING:
            // æ­£å¸¸é€šä¿¡çŠ¶æ€
            if (process_communication()) {
                last_activity = current_time;
            } else if (current_time - last_activity > kwp_config.timeout) {
                kwp_state = KWP_ERROR;
            }
            break;
            
        case KWP_ERROR:
            // é”™è¯¯å¤„ç†
            handle_error();
            kwp_state = KWP_IDLE;
            break;
    }
}
```

## ğŸ”§ å…³é”®å®ç°è¦ç‚¹

### 1. æ—¶åºæ§åˆ¶ (åŸºäºISO 14230-2)
```c
// ä¸¥æ ¼çš„æ—¶åºè¦æ±‚ (åŸºäºISO 14230-2)
#define FRAME_INTERVAL_MIN    5    // ms - å¸§é—´éš”æœ€å°å€¼
#define RESPONSE_TIMEOUT_MAX  50   // ms - å“åº”è¶…æ—¶æœ€å¤§å€¼
#define GENERAL_TIMEOUT       1000 // ms - é€šç”¨è¶…æ—¶
#define INIT_TIMEOUT          50   // ms - åˆå§‹åŒ–è¶…æ—¶

// æ—¶åºæ§åˆ¶å‡½æ•°
void kwp2000_timing_control(void) {
    static uint32_t last_frame = 0;
    uint32_t current_time = get_system_time();
    
    // ç¡®ä¿å¸§é—´éš” (åŸºäºISO 14230-2)
    if (current_time - last_frame < FRAME_INTERVAL_MIN) {
        delay_ms(FRAME_INTERVAL_MIN - (current_time - last_frame));
    }
    
    last_frame = get_system_time();
}

// ç­‰å¾…å“åº”å‡½æ•°
int wait_for_response(uint32_t timeout_ms) {
    uint32_t start_time = get_system_time();
    
    while ((get_system_time() - start_time) < timeout_ms) {
        if (uart_data_available()) {
            return 0;
        }
        delay_ms(1);
    }
    
    return -1;  // è¶…æ—¶
}
```

### 2. é”™è¯¯å¤„ç† (åŸºäºISO 14230-2)
```c
// é”™è¯¯å¤„ç†ç­–ç•¥ (åŸºäºISO 14230-2)
typedef enum {
    ERROR_NONE,
    ERROR_TIMEOUT,
    ERROR_CHECKSUM,
    ERROR_FORMAT,
    ERROR_BUSY,
    ERROR_NEGATIVE_RESPONSE
} kwp2000_error_t;

// è´Ÿå“åº”ç  (åŸºäºISO 14230-3)
typedef enum {
    NRC_SERVICE_NOT_SUPPORTED = 0x11,
    NRC_SUB_FUNCTION_NOT_SUPPORTED = 0x12,
    NRC_INCORRECT_MESSAGE_LENGTH = 0x13,
    NRC_CONDITIONS_NOT_CORRECT = 0x22,
    NRC_REQUEST_SEQUENCE_ERROR = 0x24,
    NRC_REQUEST_OUT_OF_RANGE = 0x31,
    NRC_SECURITY_ACCESS_DENIED = 0x33,
    NRC_INVALID_KEY = 0x35,
    NRC_EXCEEDED_NUMBER_OF_ATTEMPTS = 0x36,
    NRC_REQUIRED_TIME_DELAY_NOT_EXPIRED = 0x37,
    NRC_GENERAL_PROGRAMMING_FAILURE = 0x72,
    NRC_WRONG_BLOCK_SEQUENCE_COUNTER = 0x73,
    NRC_REQUEST_CORRECTLY_RECEIVED_RESPONSE_PENDING = 0x7F
} negative_response_code_t;

void handle_kwp2000_error(kwp2000_error_t error) {
    switch (error) {
        case ERROR_TIMEOUT:
            // é‡è¯•æœºåˆ¶
            if (retry_count < kwp_config.retries) {
                retry_count++;
                resend_last_message();
            } else {
                reset_communication();
            }
            break;
            
        case ERROR_CHECKSUM:
            // è¯·æ±‚é‡ä¼ 
            request_retransmission();
            break;
            
        case ERROR_FORMAT:
            // é‡æ–°åˆå§‹åŒ–
            reset_communication();
            break;
            
        case ERROR_NEGATIVE_RESPONSE:
            // å¤„ç†è´Ÿå“åº”
            handle_negative_response();
            break;
            
        default:
            // é€šç”¨é”™è¯¯å¤„ç†
            log_error(error);
            break;
    }
}

void handle_negative_response(void) {
    // æ ¹æ®è´Ÿå“åº”ç é‡‡å–ç›¸åº”æªæ–½
    switch (last_negative_response_code) {
        case NRC_SECURITY_ACCESS_DENIED:
            // é‡æ–°è¿›è¡Œå®‰å…¨è®¿é—®
            kwp2000_security_access(security.level);
            break;
            
        case NRC_CONDITIONS_NOT_CORRECT:
            // ç­‰å¾…æ¡ä»¶æ»¡è¶³
            delay_ms(100);
            break;
            
        case NRC_REQUEST_SEQUENCE_ERROR:
            // é‡æ–°åŒæ­¥
            reset_communication();
            break;
            
        default:
            // å…¶ä»–é”™è¯¯å¤„ç†
            break;
    }
}
```

### 3. åœ°å€ç®¡ç† (åŸºäºISO 14230-2)
```c
// åœ°å€å®šä¹‰ (åŸºäºISO 14230-2)
#define FUNCTIONAL_ADDRESS    0x33  // åŠŸèƒ½åœ°å€
#define BROADCAST_ADDRESS     0x7F  // å¹¿æ’­åœ°å€

// ç‰©ç†å¯»å€å’ŒåŠŸèƒ½å¯»å€
typedef enum {
    ADDRESSING_PHYSICAL,  // ç‰©ç†å¯»å€
    ADDRESSING_FUNCTIONAL // åŠŸèƒ½å¯»å€
} addressing_mode_t;

int kwp2000_set_addressing_mode(addressing_mode_t mode) {
    switch (mode) {
        case ADDRESSING_PHYSICAL:
            kwp_config.target_addr = 0x10;  // ç‰©ç†åœ°å€
            break;
            
        case ADDRESSING_FUNCTIONAL:
            kwp_config.target_addr = FUNCTIONAL_ADDRESS;
            break;
            
        default:
            return -1;
    }
    
    return 0;
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```c
// æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
void test_kwp2000_message_format(void) {
    kwp2000_message_t msg;
    
    // æµ‹è¯•æ¶ˆæ¯æ„å»º (åŸºäºISO 14230-2)
    msg.format = 0x81;
    msg.target = 0x10;
    msg.source = 0xF1;
    msg.length = 2;
    msg.data[0] = 0x22;  // ReadDataByLocalIdentifier
    msg.data[1] = 0xF1;  // æœ¬åœ°æ ‡è¯†ç¬¦
    
    // éªŒè¯æ ¡éªŒå’Œè®¡ç®—
    uint8_t expected_checksum = calculate_checksum_test(&msg);
    assert(msg.checksum == expected_checksum);
}

void test_kwp2000_timing_requirements(void) {
    // æµ‹è¯•æ—¶åºè¦æ±‚ (åŸºäºISO 14230-2)
    uint32_t start_time = get_system_time();
    
    // å‘é€æ¶ˆæ¯
    kwp2000_send_test_message();
    
    // éªŒè¯å¸§é—´éš”
    uint32_t frame_interval = get_system_time() - start_time;
    assert(frame_interval >= FRAME_INTERVAL_MIN);
}
```

### 2. é›†æˆæµ‹è¯•
```c
// ç«¯åˆ°ç«¯æµ‹è¯• (åŸºäºISO 14230-3)
void test_kwp2000_diagnostic_services(void) {
    // åˆå§‹åŒ–åè®®æ ˆ
    kwp2000_config_t config = {10400, 50, 3, 0x10, 0xF1};
    assert(kwp2000_init(&config) == 0);
    
    // æµ‹è¯•å¿«é€Ÿåˆå§‹åŒ–
    assert(kwp2000_fast_init() == 0);
    
    // æµ‹è¯•å¯åŠ¨è¯Šæ–­ä¼šè¯
    assert(kwp2000_start_diagnostic_session(SESSION_EXTENDED) == 0);
    
    // æµ‹è¯•å®‰å…¨è®¿é—®
    assert(kwp2000_security_access(0x01) == 0);
    
    // æµ‹è¯•è¯»å–æ•°æ®
    uint8_t data[10];
    int length = kwp2000_read_data_by_local_identifier(0xF1, data, sizeof(data));
    assert(length > 0);
    
    // æµ‹è¯•é”™è¯¯å¤„ç†
    assert(test_error_handling() == 0);
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ç®¡ç†
- ä½¿ç”¨é™æ€å†…å­˜æ± é¿å…åŠ¨æ€åˆ†é…
- å®ç°æ¶ˆæ¯ç¼“å­˜æœºåˆ¶
- ä¼˜åŒ–æ•°æ®ç»“æ„å¯¹é½

### 2. å®æ—¶æ€§ä¿è¯
- ä½¿ç”¨ä¸­æ–­é©±åŠ¨æ¥æ”¶
- å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—
- æœ€å°åŒ–å…³é”®è·¯å¾„å»¶è¿Ÿ

### 3. åŠŸè€—ä¼˜åŒ–
- å®ç°ç¡çœ æ¨¡å¼
- åŠ¨æ€è°ƒæ•´é€šä¿¡é¢‘ç‡
- ä¼˜åŒ–å”¤é†’æœºåˆ¶

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. é€šä¿¡è¶…æ—¶
**é—®é¢˜**: é¢‘ç¹å‡ºç°é€šä¿¡è¶…æ—¶
**åŸå› **: æ—¶åºæ§åˆ¶ä¸å½“ã€ç¡¬ä»¶é—®é¢˜
**è§£å†³**: æ£€æŸ¥æ—¶åºå‚æ•°ã€éªŒè¯ç¡¬ä»¶è¿æ¥

### 2. æ ¡éªŒé”™è¯¯
**é—®é¢˜**: æ ¡éªŒå’Œé”™è¯¯ç‡é«˜
**åŸå› **: ç”µæ°”å¹²æ‰°ã€æ³¢ç‰¹ç‡ä¸åŒ¹é…
**è§£å†³**: æ”¹å–„å±è”½ã€æ ¡å‡†æ³¢ç‰¹ç‡

### 3. çŠ¶æ€æœºå¡æ­»
**é—®é¢˜**: åè®®çŠ¶æ€æœºå¡åœ¨æŸä¸ªçŠ¶æ€
**åŸå› **: çŠ¶æ€è½¬æ¢é€»è¾‘é”™è¯¯
**è§£å†³**: æ·»åŠ è¶…æ—¶ä¿æŠ¤ã€å®Œå–„çŠ¶æ€è½¬æ¢

### 4. å®‰å…¨è®¿é—®å¤±è´¥
**é—®é¢˜**: å®‰å…¨è®¿é—®é¢‘ç¹å¤±è´¥
**åŸå› **: å¯†é’¥ç®—æ³•é”™è¯¯ã€æ—¶åºé—®é¢˜
**è§£å†³**: éªŒè¯å¯†é’¥ç®—æ³•ã€æ£€æŸ¥æ—¶åº

## ğŸ“š å‚è€ƒæ ‡å‡†

- **ISO 14230-1**: ç‰©ç†å±‚è§„èŒƒ
- **ISO 14230-2**: æ•°æ®é“¾è·¯å±‚è§„èŒƒ  
- **ISO 14230-3**: åº”ç”¨å±‚è§„èŒƒ
- **SSF 14230**: ç‘å…¸å®æ–½æ ‡å‡†
- **SAE J1979**: OBD-IIè¯Šæ–­æµ‹è¯•æ¨¡å¼

---

*æœ¬æ–‡æ¡£åŸºäºISO 14230å›½é™…æ ‡å‡†å’ŒSSF 14230ç‘å…¸å®æ–½æ ‡å‡†ç¼–å†™ï¼Œæä¾›KWP2000åè®®å®ç°çš„åŸºç¡€æ¡†æ¶ï¼Œå…·ä½“å®ç°éœ€è¦æ ¹æ®ç¡¬ä»¶å¹³å°å’Œåº”ç”¨éœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚*
